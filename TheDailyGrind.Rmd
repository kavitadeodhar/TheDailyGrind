---
title: "The Daily Grind"
author: "Sumit Gupta, Kavita Deodhar"
date: "April 18, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(twitteR)
library(dplyr)
library(stringr)
library(tm)
library(DataCombine)
library(wordcloud)
library(RColorBrewer)
library(readr)
library(syuzhet)
library(ggplot2)

api_key <- "Od5rpMWWch3FVBDVBfeFVUjV3"
api_secret <- "zibZTX8dUmtSEdsHtIG20ErRhnAjA3GqFC2pGSZJ54ImG1Y6B6"
access_token <- "915794173-7YxpWXQRfsjbmIWFuSJbr5EzPLJqQ9XSdOjkTmO0"
access_token_secret <- "P09dahyCxPhuTpJ3sXhZfNgZEALpr8jkaWIA2DwEcMbLq"
options(httr_oauth_cache = TRUE)# This option is to force direct authentication.
setup_twitter_oauth(api_key,api_secret,access_token,access_token_secret)

#Read the emoji decoder file
emoji_decoder <- read_delim("https://raw.githubusercontent.com/today-is-a-good-day/Emoticons/master/emDict.csv",delim = ";")

Dunkin <- searchTwitter('Dunkin + coffee', n = 1000,since='2016-01-01', until='2016-04-19',lang='en')

Dunkin_df <- twListToDF(Dunkin)

Dunkin_byte <- data.frame(text_emoji=iconv(Dunkin_df$text,"latin1","ASCII","byte")) 

Dunkin_bind <- cbind(Dunkin_df,Dunkin_byte) %>% select (text_emoji,created,id)


Dunkin_convert_emoji <- FindReplace(data = Dunkin_bind,Var = "text_emoji",replaceData = emoji_decoder,from = "R-encoding",to="Description",exact = FALSE)
colnames(Dunkin_convert_emoji)[1] <- "text"

Starbucks <- searchTwitter('Starbucks + coffee', n = 1000,since='2016-01-01', until='2016-04-19',lang='en')

Starbucks_df <- twListToDF(Starbucks)

Starbucks_byte <- data.frame(text_emoji=iconv(Starbucks_df$text,"latin1","ASCII","byte")) 

Starbucks_bind <- cbind(Starbucks_df,Starbucks_byte) %>% select (text_emoji,created,id)

Starbucks_convert_emoji <- FindReplace(data = Starbucks_bind,Var = "text_emoji",replaceData = emoji_decoder,from = "R-encoding",to="Description",exact = FALSE)
colnames(Starbucks_convert_emoji)[1] <- "text"

#rm(list=ls())
```

## Cleaning the data

Using the tm package and the gsub to clean the tweets.

```{r, echo=FALSE}
clean_tweets <- function(datafeed) {
#Remove handles
datafeed_list <- str_replace_all(datafeed$text, "@\\w+", "")
datafeed_list <- Corpus(VectorSource(datafeed_list))
#Remove punctuation
datafeed_list <- tm_map(datafeed_list,removePunctuation)
#Remove Stopwords
datafeed_list <- tm_map(datafeed_list, removeWords, stopwords("english"))
#Convert the text to lower case
datafeed_list <- tm_map(datafeed_list,content_transformer(tolower))
datafeed_list <- tm_map(datafeed_list,removeWords,c("amp","dunkin","starbucks","http","https"))
#Remove whitespace
datafeed_list <- tm_map(datafeed_list,stripWhitespace)
}

Dunkin_vector <- clean_tweets(Dunkin_convert_emoji)
Starbucks_vector <- clean_tweets(Starbucks_convert_emoji)


Dunkin_clean_df <- data.frame(text=unlist(sapply(Dunkin_vector, `[`,"content")),stringAsFactors=F) 
Dunkin_clean_df <- cbind(Dunkin_clean_df$text,Dunkin_convert_emoji) %>% select (-text)  
colnames(Dunkin_clean_df)[1] <- "text"

Starbucks_clean_df <- data.frame(text=unlist(sapply(Starbucks_vector, `[`,"content")),stringAsFactors=F)
Starbucks_clean_df <- cbind(Starbucks_clean_df$text,Starbucks_convert_emoji) %>% select (-text)  
colnames(Starbucks_clean_df)[1] <- "text"

######################
mytweets <- get_nrc_sentiment(as.character(Dunkin_clean_df$text))
head(mytweets)
tweets <- cbind(Dunkin_clean_df, mytweets)
sentimentTotals <- data.frame(colSums(tweets[,c(3:11)]))
names(sentimentTotals) <- "count"
sentimentTotals <- cbind("sentiment" = rownames(sentimentTotals), sentimentTotals)
rownames(sentimentTotals) <- NULL
ggplot(data = sentimentTotals, aes(x = sentiment, y = count)) +
        geom_bar(aes(fill = sentiment), stat = "identity") +
        theme(legend.position = "none") +
        xlab("Sentiment") + ylab("Total Count") + ggtitle("Total Sentiment Score for All Tweets")
#########################
#gc()
#Dunkin wordcloud
pal <- brewer.pal(9,"YlGnBu")
pal <- pal[-(1:4)]
set.seed(123)
wordcloud(words = Dunkin_vector, scale=c(5,0.5), max.words=200, random.order=FALSE, 
          rot.per=0.45, use.r.layout=FALSE, colors=pal)




```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
